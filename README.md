# Бот статуса сервера Vintage Story Discord

Этот бот разработан для отслеживания статуса сервера Vintage Story и отправки уведомлений в Discord канал. Проект состоит из двух частей:
- **StatusMod** - C# мод для Vintage Story, который предоставляет API для получения статуса сервера
- **DiscordBot** - Python бот для Discord, который получает информацию от сервера и отправляет уведомления

## Установка и настройка

### Discord бот
1. Клонируйте репозиторий
```bash
git clone https://github.com/your-username/StatusDiscordBot.git
cd StatusDiscordBot
```

2. Установите зависимости
```bash
pip install -r requirements.txt
```

3. Настройте конфигурацию
```bash
cp DiscordBot/.env.example DiscordBot/.env
# Отредактируйте .env файл, указав ваш Discord токен и другие настройки
```

4. Запустите бота
```bash
cd DiscordBot
python bot.py
```

### Мод StatusMod
1. Скомпилируйте мод из исходников или используйте предварительно скомпилированный DLL файл
2. Поместите скомпилированный DLL файл в директорию модов сервера Vintage Story
3. Перезапустите сервер Vintage Story

## Команды бота

Ниже приведен полный список команд бота. Префикс команд: `!` или `/`

### Основные команды

| Команда | Алиас | Описание | Пример |
|---------|-------|----------|--------|
| `ping` | `пинг` | Проверяет время отклика бота | `!ping` |
| `uptime` | `аптайм` | Показывает время работы бота | `!uptime` |
| `status` | `статус` | Отображает текущий статус сервера | `!статус` |

### Управление сервером

| Команда | Алиас | Доступ | Описание | Пример |
|---------|-------|--------|----------|--------|
| `maintenance [причина]` | `тех_работы [причина]` | Администратор | Включает/выключает режим технического обслуживания сервера | `!тех_работы Обновление мира` |

### Тестовые уведомления

| Команда | Алиас | Доступ | Описание | Пример |
|---------|-------|--------|----------|--------|
| `test_storm [тип]` | `тест_шторм [тип]` | Администратор | Отправляет тестовое уведомление о шторме. Типы: `start` (начало), `warning` (предупреждение), `end` (конец) | `!тест_шторм warning` |
| `test_season [тип]` | `тест_сезон [тип]` | Администратор | Отправляет тестовое уведомление о смене сезона. Типы: `spring` (весна), `summer` (лето), `autumn` (осень), `winter` (зима) | `!тест_сезон winter` |

### Управление гайдами

| Команда | Алиас | Доступ | Описание | Пример |
|---------|-------|--------|----------|--------|
| `guides` | `гайды` | Все | Отображает список доступных гайдов | `!гайды` |
| `guide [номер]` | `гайд [номер]` | Все | Отображает конкретный гайд по его номеру | `!гайд 1` |
| `add_guide` | `добавить_гайд` | Администратор | Добавляет новый гайд | `!добавить_гайд Название | Описание | [URL изображения] | [Автор]` |
| `add_section [номер_гайда]` | `добавить_раздел [номер_гайда]` | Администратор | Добавляет новый раздел к существующему гайду | `!добавить_раздел 1 Заголовок раздела | Содержание раздела` |
| `remove_guide [номер]` | `удалить_гайд [номер]` | Администратор | Удаляет гайд по его номеру | `!удалить_гайд 1` |

### Управление сообщениями бота

| Команда | Алиас | Доступ | Описание | Пример |
|---------|-------|--------|----------|--------|
| `reload_messages` | `перезагрузить_сообщения` | Администратор | Перезагружает все сообщения из файлов | `!перезагрузить_сообщения` |
| `list_messages [тип]` | `список_сообщений [тип]` | Администратор | Отображает список доступных сообщений указанного типа. Типы: `storm`, `season` | `!список_сообщений storm` |
| `add_message [тип] [ключ] [текст]` | `добавить_сообщение [тип] [ключ] [текст]` | Администратор | Добавляет новое сообщение указанного типа. Типы: `storm`, `season`. Ключи для storm: `storm_start`, `storm_warning`, `storm_end`. Ключи для season: `spring`, `summer`, `autumn`, `winter` | `!добавить_сообщение storm storm_warning Внимание! Приближается шторм!` |
| `remove_message [тип] [ключ] [индекс]` | `удалить_сообщение [тип] [ключ] [индекс]` | Администратор | Удаляет сообщение указанного типа по ключу и индексу. Если индекс не указан, удаляются все сообщения с указанным ключом | `!удалить_сообщение storm storm_warning 0` |

## Обработка уведомлений

Бот принимает HTTP-запросы от игрового сервера для отправки уведомлений в канал Discord:

- **Штормы**: Оповещения о начале, предупреждении и окончании шторма
- **Сезоны**: Оповещения о смене сезонов (весна, лето, осень, зима)
- **Статус сервера**: Обновление информации о статусе и игроках

## Режим технического обслуживания

Когда режим технического обслуживания активен:
1. Статус бота изменяется на "Тех. обслуживание"
2. Уведомления о штормах и сезонах не отправляются
3. В команде `!статус` отображается информация о техобслуживании и его причина

## Файлы данных

Бот использует следующие файлы для хранения данных:

- `server_status.json`: Информация о текущем статусе сервера
- `storm_messages.json`: Сообщения для уведомлений о штормах
- `season_messages.json`: Сообщения для уведомлений о сезонах
- `guides.json`: Гайды, которые можно просматривать через команды `!гайды` и `!гайд`

## Структура проекта

```
StatusDiscordBot/
├── requirements.txt      # Зависимости проекта
├── README.md            # Документация
├── .gitignore           # Настройки Git
├── StatusMod/           # Мод для Vintage Story
│   ├── statusmodModSystem.cs  # Основной файл мода
│   └── ... (другие файлы мода)
└── DiscordBot/          # Discord бот на Python
    ├── bot.py           # Основной файл бота
    ├── config.example.py # Пример настроек
    ├── .env.example     # Пример переменных окружения
    ├── cogs/            # Модули бота
    │   ├── guides.py    # Система гайдов
    │   ├── messages.py  # Управление сообщениями
    │   ├── notifications.py  # Система уведомлений
    │   └── server_status.py  # Мониторинг сервера и тех. обслуживание
    └── data/            # Данные бота
        ├── guides.json  # Хранение гайдов
        ├── season_messages.json # Сезонные сообщения
        ├── server_status.json   # Статус сервера
        └── storm_messages.json  # Сообщения о штормах
```

## Функциональность

- **Мониторинг игроков**: Количество и имена онлайн игроков
- **Игровое время**: Текущий сезон, день и время
- **Уведомления о штормах**: Автоматические оповещения о темпоральных бурях
- **Уведомления о смене сезонов**: Автоматические оповещения о смене сезонов
- **Discord-команды**: Команда `!status` для информации о сервере
- **Отображение в статусе**: Статус сервера отображается в описании бота
- **Гайды**: Возможность добавлять и просматривать гайды по игре
- **Модульная структура**: Код бота разделен на модули (cogs) для удобства поддержки

## Требования

### Для Discord бота
- **Python 3.8+**
- **discord.py 2.0+**
- **python-dotenv**
- **aiohttp**
- **requests**
- **python-dateutil**

### Для StatusMod
- **Vintage Story Server**
- **VintagestoryAPI**
- **.NET SDK**

## Настройка бота

Для настройки бота используется файл `.env`. Создайте его, скопировав содержимое из `.env.example` и заполнив своими данными:

```
# Токен Discord бота (обязательно)
DISCORD_TOKEN=your_discord_token_here

# URL вашего Vintage Story сервера (обязательно)
VS_SERVER_URL=http://localhost:8080/status/

# Настройки уведомлений
NOTIFICATION_CHANNEL_ID=0000000000000000000
NOTIFICATION_PORT=8081

# Настройки бота
SERVER_NAME=Vintage Story Server
ADMIN_ROLE_ID=0000000000000000000
STATUS_CHANNEL_ID=0000000000000000000

# Настройки оповещений
USE_EXTENDED_NOTIFICATIONS=True

# Настройки таймеров (в минутах, если не указано иное)
SERVER_STATUS_CHECK=0.5
STATUS_UPDATE=0.5
MAINTENANCE_CHECK=2
HTTP_TIMEOUT=30
NOTIFICATION_COOLDOWN=5
RECONNECT_DELAY=60

# Максимальное количество игроков по умолчанию
DEFAULT_MAX_PLAYERS=32
```

## Модульная структура (Cogs)

Бот использует систему модулей (cogs) для разделения функциональности:

1. **server_status.py** - Управление статусом сервера, техническим обслуживанием и отображение информации
2. **notifications.py** - Обработка уведомлений от игрового сервера (штормы, сезоны)
3. **guides.py** - Управление гайдами и их отображение
4. **messages.py** - Управление настраиваемыми сообщениями бота

## API

### Получение статуса сервера
- **Endpoint**: `http://localhost:8080/status/`
- **Метод**: GET
- **Формат ответа**: JSON

### Отправка уведомлений
- **Endpoint**: `http://localhost:8081/status/notification`
- **Метод**: POST
- **Формат данных**: JSON
- **Типы уведомлений**: 
  - `storm_notification` - уведомления о штормах
  - `season_notification` - уведомления о смене сезонов
  - `server_status` - обновления статуса сервера

## Устранение неполадок

- **Бот не может подключиться к серверу**:
  - Убедитесь, что сервер Vintage Story запущен с модом Status Mod.
  - Проверьте, что порт 8080 не блокируется брандмауэром.
  - Убедитесь, что порт 8080 не используется другими приложениями.

- **Бот не отправляет сообщения в Discord**:
  - Проверьте правильность токена бота в `.env`.
  - Убедитесь, что бот имеет права на отправку сообщений и встраиваемых ссылок.
  - Проверьте, что ID канала для уведомлений указан корректно.

- **Не приходят уведомления о штормах или сезонах**:
  - Убедитесь, что порт 8081 не блокируется брандмауэром.
  - Проверьте, что ID канала для уведомлений в `.env` указан правильно.
  - Проверьте, что файлы `storm_messages.json` и `season_messages.json` существуют и содержат корректные данные.

## Вклад в проект

Если вы хотите внести свой вклад в проект:
1. Форкните репозиторий
2. Создайте ветку для вашей фичи (`git checkout -b feature/amazing-feature`)
3. Внесите изменения и закоммитьте их (`git commit -m 'Add some amazing feature'`)
4. Отправьте ветку на GitHub (`git push origin feature/amazing-feature`)
5. Создайте Pull Request

## Лицензия

MIT License
